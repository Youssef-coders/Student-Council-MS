<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="light">
  <title>Export Club Submissions - MRIS Council Admin</title>
  <link rel="icon" href="Untitled design (4).png">
  
  <!-- Firebase SDK -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAIDGXmoC64L3D5NSyzvdOIHxoioeHQwNg",
      authDomain: "mrismscouncil.firebaseapp.com",
      projectId: "mrismscouncil",
      storageBucket: "mrismscouncil.firebasestorage.app",
      messagingSenderId: "443307185373",
      appId: "1:443307185373:web:48575eae2c3437a16ff734",
      measurementId: "G-LP2SDDZEBB"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Make Firebase available globally
    window.firebase = { db, collection, getDocs, addDoc };
    window.firebaseCollection = collection;
    window.firebaseGetDocs = getDocs;
    window.firebaseAddDoc = addDoc;
    console.log('Firebase initialized successfully!');
  </script>
  
  <style>
    html, body {
      background: #ffffff !important;
      background-color: #ffffff !important;
      color: #1e40af !important;
    }
    
    @media (prefers-color-scheme: dark) {
      html:not([data-theme="dark"]), 
      html:not([data-theme="dark"]) body {
        background: #ffffff !important;
        background-color: #ffffff !important;
        color: #1e40af !important;
      }
    }
    
    html, body, * {
      -webkit-filter: none !important;
      filter: none !important;
      -webkit-text-fill-color: initial !important;
    }
  </style>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <nav>
    <div class="container">
      <a href="index.html" class="nav-logo">
        <img src="Untitled design (4).png" alt="MRIS Logo">
        MRIS Council - Admin
      </a>
      <div class="links">
        <a href="index.html" class="btn btn-dark">Back to Home</a>
      </div>
    </div>
  </nav>

  <header class="hero">
    <h1>üìä Export Club Submissions</h1>
    <p>Download all club idea suggestions as a spreadsheet</p>
  </header>

  <section>
    <div class="form-container">
      <div id="stats" style="margin-bottom: 2rem;">
        <h3 style="color: var(--text-primary);">Submission Statistics</h3>
        <p id="total-submissions" style="font-size: 1.2rem; font-weight: 600; color: var(--text-primary);">Total Submissions: 0</p>
      </div>

      <div id="submissions-list" style="margin-bottom: 2rem;">
        <h3 style="color: var(--text-primary); margin-bottom: 1rem;">All Submissions</h3>
        <div id="submissions-container"></div>
      </div>

        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
          <button id="export-csv" class="btn btn-primary">
            üì• Download as CSV (Spreadsheet)
          </button>
          <button id="migrate-local" class="btn btn-dark" style="background: #059669;">
            üîÑ Migrate Local Submissions to Firebase
          </button>
          <button id="cleanup-duplicates" class="btn btn-dark" style="background: #f59e0b;">
            üßπ Clean Duplicates (Same Name)
          </button>
          <button id="clear-all" class="btn btn-dark" style="background: #dc2626;">
            üóëÔ∏è Clear All Data
          </button>
        </div>
    </div>
  </section>

  <footer>
    &copy; 2025 MRIS Council. Student-powered, always.
  </footer>

  <button id="darkModeToggle" class="btn-icon" aria-label="Toggle dark mode">
    <span class="icon-sun">‚òÄÔ∏è</span>
    <span class="icon-moon">üåô</span>
  </button>

  <script>
    // Dark Mode Toggle
    const darkModeToggle = document.getElementById('darkModeToggle');
    const html = document.documentElement;
    
    const currentTheme = localStorage.getItem('theme') || 'light';
    html.setAttribute('data-theme', currentTheme);
    
    darkModeToggle.addEventListener('click', () => {
      const theme = html.getAttribute('data-theme');
      const newTheme = theme === 'light' ? 'dark' : 'light';
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    });
  </script>

  <script>
    // Load and display submissions
    async function loadSubmissions() {
      let allSubmissions = [];
      
      try {
        // Wait for Firebase to be ready
        let attempts = 0;
        while (!window.firebase && attempts < 50) {
          await new Promise(resolve => setTimeout(resolve, 100));
          attempts++;
        }
        
        if (!window.firebase) {
          throw new Error('Firebase not loaded. Please refresh the page and try again.');
        }
        
        // Try to load from Firebase first
        console.log('Loading submissions from Firebase...');
        const submissionsRef = window.firebaseCollection(window.firebase.db, 'submissions');
        const snapshot = await window.firebaseGetDocs(submissionsRef);
        
        snapshot.forEach((doc) => {
          allSubmissions.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('Firebase submissions:', allSubmissions);
        
        // If no Firebase submissions, fallback to localStorage
        if (allSubmissions.length === 0) {
          console.log('No Firebase submissions, checking localStorage...');
          allSubmissions = JSON.parse(localStorage.getItem('schoolClubSubmissions') || '[]');
          console.log('localStorage submissions:', allSubmissions);
          
          if (allSubmissions.length === 0) {
            allSubmissions = JSON.parse(localStorage.getItem('allClubSubmissions') || '[]');
          }
        }
        
      } catch (error) {
        console.error('Error loading from Firebase:', error);
        
        // Fallback to localStorage if Firebase fails
        console.log('Firebase failed, using localStorage...');
        allSubmissions = JSON.parse(localStorage.getItem('schoolClubSubmissions') || '[]');
        if (allSubmissions.length === 0) {
          allSubmissions = JSON.parse(localStorage.getItem('allClubSubmissions') || '[]');
        }
      }
      
      // Update count
      document.getElementById('total-submissions').textContent = `Total Submissions: ${allSubmissions.length}`;
      
      // Display submissions
      const container = document.getElementById('submissions-container');
      container.innerHTML = '';
      
      if (allSubmissions.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
            <p>No submissions yet.</p>
            <p style="font-size: 0.9rem; margin-top: 1rem;">
              Submit ideas at: <a href="forms.html" style="color: var(--primary-color);">forms.html</a>
            </p>
            <button onclick="createTestSubmission()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer;">
              Create Test Submission
            </button>
          </div>
        `;
        return;
      }
      
      allSubmissions.forEach((submission, index) => {
        const card = document.createElement('div');
        card.style.cssText = 'background: rgba(255,255,255,0.5); border: 1px solid rgba(30,64,175,0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;';
        
        const date = new Date(submission.timestamp).toLocaleString();
        
        card.innerHTML = `
          <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">${index + 1}. ${submission.name} (${submission.class})</h4>
          <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem;">Submitted: ${date}</p>
          <div style="margin-left: 1rem;">
            <p style="margin-bottom: 0.5rem;"><strong>1.</strong> ${submission.suggestion1}</p>
            ${submission.suggestion2 ? `<p style="margin-bottom: 0.5rem;"><strong>2.</strong> ${submission.suggestion2}</p>` : ''}
            ${submission.suggestion3 ? `<p style="margin-bottom: 0.5rem;"><strong>3.</strong> ${submission.suggestion3}</p>` : ''}
          </div>
          ${submission.location || submission.howItWorks || submission.whyCreate ? `
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(30,64,175,0.2);">
              <p style="font-weight: 600; margin-bottom: 0.5rem;">Extra Details:</p>
              ${submission.location ? `<p style="margin-bottom: 0.5rem;"><strong>Location:</strong> ${submission.location}</p>` : ''}
              ${submission.howItWorks ? `<p style="margin-bottom: 0.5rem;"><strong>How it works:</strong> ${submission.howItWorks}</p>` : ''}
              ${submission.whyCreate ? `<p style="margin-bottom: 0.5rem;"><strong>Why create:</strong> ${submission.whyCreate}</p>` : ''}
            </div>
          ` : ''}
        `;
        
        container.appendChild(card);
      });
    }
    
    // Duplicate removal function
    async function removeDuplicates() {
      try {
        if (!window.firebase) {
          console.log('Firebase not ready for duplicate removal');
          return;
        }
        
        console.log('üîç Checking for duplicates...');
        
        // Get all Firebase submissions
        const submissionsRef = window.firebaseCollection(window.firebase.db, 'submissions');
        const snapshot = await window.firebaseGetDocs(submissionsRef);
        
        const submissions = [];
        snapshot.forEach((doc) => {
          submissions.push({ id: doc.id, ...doc.data() });
        });
        
        console.log(`üìä Found ${submissions.length} total submissions`);
        
        // Group submissions by name to find name-based duplicates
        const nameGroups = {};
        submissions.forEach(submission => {
          if (!nameGroups[submission.name]) {
            nameGroups[submission.name] = [];
          }
          nameGroups[submission.name].push(submission);
        });
        
        // Find duplicates by name (keep the first one, remove the rest)
        const duplicates = [];
        Object.keys(nameGroups).forEach(name => {
          const group = nameGroups[name];
          if (group.length > 1) {
            console.log(`üîÑ Found ${group.length} submissions from ${name}, keeping the first one`);
            // Sort by timestamp to keep the earliest submission
            group.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            // Remove all except the first one
            for (let i = 1; i < group.length; i++) {
              duplicates.push(group[i]);
            }
          }
        });
        
        if (duplicates.length > 0) {
          console.log(`üßπ Found ${duplicates.length} duplicates, removing...`);
          
          // Delete duplicates from Firebase
          const { deleteDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
          const deletePromises = duplicates.map(duplicate => {
            return deleteDoc(doc(window.firebase.db, 'submissions', duplicate.id));
          });
          
          await Promise.all(deletePromises);
          
          console.log(`‚úÖ Removed ${duplicates.length} duplicate submissions`);
          
          // Update the display
          await loadSubmissions();
          
          // Show notification
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            font-weight: 600;
          `;
          notification.textContent = `üßπ Removed ${duplicates.length} duplicate submissions`;
          document.body.appendChild(notification);
          
          // Remove notification after 3 seconds
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 3000);
          
        } else {
          console.log('‚úÖ No duplicates found');
        }
        
      } catch (error) {
        console.error('‚ùå Error removing duplicates:', error);
      }
    }
    
    // Auto-remove duplicates every 10 seconds
    setInterval(removeDuplicates, 10000);
    
    // Also run once on page load (after a delay to ensure Firebase is ready)
    setTimeout(removeDuplicates, 5000);
    
    // Manual cleanup button
    document.getElementById('cleanup-duplicates').addEventListener('click', async () => {
      const button = document.getElementById('cleanup-duplicates');
      const originalText = button.textContent;
      
      button.disabled = true;
      button.textContent = 'üßπ Cleaning...';
      
      try {
        await removeDuplicates();
        alert('‚úÖ Cleanup complete! Duplicates have been removed.');
      } catch (error) {
        console.error('Cleanup error:', error);
        alert('‚ùå Cleanup failed. Please try again.');
      } finally {
        button.disabled = false;
        button.textContent = originalText;
      }
    });
    
    // Export to CSV
    document.getElementById('export-csv').addEventListener('click', async () => {
      let allSubmissions = [];
      
      try {
        // Try to load from Firebase first
        const submissionsRef = window.firebaseCollection(window.firebase.db, 'submissions');
        const snapshot = await window.firebaseGetDocs(submissionsRef);
        
        snapshot.forEach((doc) => {
          allSubmissions.push({ id: doc.id, ...doc.data() });
        });
        
        // If no Firebase submissions, fallback to localStorage
        if (allSubmissions.length === 0) {
          allSubmissions = JSON.parse(localStorage.getItem('schoolClubSubmissions') || '[]');
          if (allSubmissions.length === 0) {
            allSubmissions = JSON.parse(localStorage.getItem('allClubSubmissions') || '[]');
          }
        }
      } catch (error) {
        console.error('Error loading submissions for export:', error);
        // Fallback to localStorage
        allSubmissions = JSON.parse(localStorage.getItem('schoolClubSubmissions') || '[]');
        if (allSubmissions.length === 0) {
          allSubmissions = JSON.parse(localStorage.getItem('allClubSubmissions') || '[]');
        }
      }
      
      if (allSubmissions.length === 0) {
        alert('No submissions to export!');
        return;
      }
      
      // Create CSV content
      let csv = 'Name,Class,Suggestion 1,Suggestion 2,Suggestion 3,Location,How It Works,Why Create,Timestamp\n';
      
      allSubmissions.forEach(sub => {
        const row = [
          `"${sub.name}"`,
          `"${sub.class}"`,
          `"${sub.suggestion1}"`,
          `"${sub.suggestion2 || ''}"`,
          `"${sub.suggestion3 || ''}"`,
          `"${sub.location || ''}"`,
          `"${sub.howItWorks || ''}"`,
          `"${sub.whyCreate || ''}"`,
          `"${new Date(sub.timestamp).toLocaleString()}"`
        ].join(',');
        csv += row + '\n';
      });
      
      // Create download link
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `club_submissions_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      alert(`Exported ${allSubmissions.length} submissions successfully!`);
    });
    
    // Clear all data
    document.getElementById('clear-all').addEventListener('click', () => {
      if (confirm('Are you sure you want to delete ALL submissions? This cannot be undone!')) {
        if (confirm('FINAL WARNING: This will permanently delete all data. Continue?')) {
          localStorage.removeItem('schoolClubSubmissions');
          localStorage.removeItem('backupClubSubmissions');
          localStorage.removeItem('allClubSubmissions');
          loadSubmissions();
          alert('All submissions have been deleted.');
        }
      }
    });
    
    // Create test submission for debugging
    function createTestSubmission() {
      const testSubmission = {
        name: "Test User",
        class: "9AM1",
        suggestion1: "Chess Club - Strategic thinking and friendly competition",
        suggestion2: "Debate Club - Improve public speaking and critical thinking",
        suggestion3: "Programming Club - Learn coding and technology skills",
        location: "Library",
        howItWorks: "Weekly meetings with activities and competitions",
        whyCreate: "To provide students with engaging extracurricular activities",
        timestamp: Date.now(),
        deviceId: "test-device-123"
      };
      
      let allSubmissions = JSON.parse(localStorage.getItem('schoolClubSubmissions') || '[]');
      allSubmissions.push(testSubmission);
      localStorage.setItem('schoolClubSubmissions', JSON.stringify(allSubmissions));
      localStorage.setItem('backupClubSubmissions', JSON.stringify(allSubmissions));
      
      alert('Test submission created!');
      loadSubmissions();
    }

    // Migrate local submissions to Firebase
    document.getElementById('migrate-local').addEventListener('click', async () => {
      try {
        // Get local submissions
        let localSubmissions = JSON.parse(localStorage.getItem('schoolClubSubmissions') || '[]');
        if (localSubmissions.length === 0) {
          localSubmissions = JSON.parse(localStorage.getItem('allClubSubmissions') || '[]');
        }
        
        if (localSubmissions.length === 0) {
          alert('No local submissions to migrate!');
          return;
        }
        
        if (!confirm(`Found ${localSubmissions.length} local submissions. Migrate them to Firebase?`)) {
          return;
        }
        
        // Add each submission to Firebase
        const submissionsRef = window.firebaseCollection(window.firebase.db, 'submissions');
        let migratedCount = 0;
        
        for (const submission of localSubmissions) {
          try {
            await window.firebaseAddDoc(submissionsRef, submission);
            migratedCount++;
          } catch (error) {
            console.error('Error migrating submission:', error);
          }
        }
        
        alert(`Successfully migrated ${migratedCount} out of ${localSubmissions.length} submissions to Firebase!`);
        loadSubmissions(); // Refresh the display
        
      } catch (error) {
        console.error('Error during migration:', error);
        alert('Migration failed. Please check console for details.');
      }
    });

    // Load submissions on page load
    window.addEventListener('DOMContentLoaded', loadSubmissions);
  </script>

  <style>
    html[data-theme="dark"] #submissions-container > div {
      background: rgba(51, 65, 85, 0.5) !important;
      border-color: rgba(96, 165, 250, 0.3) !important;
    }
    
    html[data-theme="dark"] h4,
    html[data-theme="dark"] p,
    html[data-theme="dark"] strong {
      color: #ffffff !important;
    }
  </style>
</body>
</html>

